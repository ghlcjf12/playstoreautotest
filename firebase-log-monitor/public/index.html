<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>자동화 로그 모니터</title>
    <style>
      body {
        font-family: 'Noto Sans KR', system-ui, sans-serif;
        background: #0f172a;
        color: #e2e8f0;
        padding: 32px;
      }
      h1 {
        font-size: 26px;
        margin-bottom: 4px;
        color: #f1f5f9;
      }
      main {
        max-width: 960px;
        margin: 0 auto;
      }
      .chip {
        background: rgba(59, 130, 246, 0.15);
        color: #93c5fd;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .card {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.2);
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(2, 6, 23, 0.4);
        margin-bottom: 24px;
      }
      .log-item {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(94, 234, 212, 0.2);
        padding: 16px;
        border-radius: 16px;
        margin-bottom: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 18px;
      }
      .log-left {
        flex: 1;
      }
      .log-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 6px;
      }
      .log-meta {
        font-size: 13px;
        color: #94a3b8;
        line-height: 1.5;
      }
      button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
      }
      button:hover {
        background: #2563eb;
      }
      .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-top: 16px;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Play Store Auto Tester 로그 모니터</h1>
      <p>Firestore <code>autoTestLogs</code> 컬렉션에서 실시간 통계를 가져옵니다.</p>
      <div class="toolbar">
        <button id="refreshBtn">새로고침</button>
        <button id="clearBtn">로그 초기화</button>
        <span id="stateChip" class="chip">...</span>
      </div>
      <section id="stats" class="card">
        <h2>실행 통계</h2>
        <div id="statList"></div>
      </section>
      <section id="logList"></section>
    </main>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        query,
        orderBy,
        limit,
        deleteDoc,
        doc
      } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
      import { firebaseConfig, autoTestLogsCollection } from "./firebase-config.js";

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const statListEl = document.getElementById("statList");
      const logListEl = document.getElementById("logList");
      const stateChip = document.getElementById("stateChip");
      const refreshBtn = document.getElementById("refreshBtn");
      const clearBtn = document.getElementById("clearBtn");

      refreshBtn.addEventListener("click", () => render());
      clearBtn.addEventListener("click", async () => {
        stateChip.textContent = "삭제 중…";
        const snapshot = await getDocs(collection(db, autoTestLogsCollection));
        await Promise.all(snapshot.docs.map((entry) => deleteDoc(doc(db, autoTestLogsCollection, entry.id))));
        await render();
      });

      async function render() {
        stateChip.textContent = "불러오는 중…";
        const snapshot = await getDocs(query(
          collection(db, autoTestLogsCollection),
          orderBy("startTime", "desc"),
          limit(50)
        ));

        const logs = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
        const stats = computeStats(logs);

        statListEl.innerHTML = "";
        Object.entries(stats.display).forEach(([label, value]) => {
          const row = document.createElement("div");
          row.style.display = "flex";
          row.style.justifyContent = "space-between";
          row.style.padding = "4px 0";
          row.innerHTML = `<span>${label}</span><strong>${value}</strong>`;
          statListEl.appendChild(row);
        });

        logListEl.innerHTML = "";
        if (logs.length === 0) {
          logListEl.innerHTML = "<div class='card'>로그가 없습니다.</div>";
        } else {
          logs.forEach((log) => {
            const card = document.createElement("div");
            card.className = "log-item";
            const left = document.createElement("div");
            left.className = "log-left";
            left.innerHTML = `
              <div class="log-title">${log.packageName || "알 수 없음"}</div>
              <div class="log-meta">
                시작: ${formatTimestamp(log.startTime)}<br />
                종료: ${formatTimestamp(log.endTime)}<br />
                터치: ${log.touchCount ?? 0}
              </div>
            `;
            const right = document.createElement("div");
            right.innerHTML = `<span class="chip">${(log.status || "unknown").toUpperCase()}</span>`;
            card.appendChild(left);
            card.appendChild(right);
            logListEl.appendChild(card);
          });
        }

        stateChip.textContent = `로그 ${logs.length}개 · ${stats.running ? "실행 중" : "대기 중"}`;
      }

      function computeStats(logs) {
        const total = logs.filter((item) => item.status !== "running").length;
        const today = logs.filter((item) => {
          if (!item.startTime) return false;
          const start = new Date(item.startTime);
          const now = new Date();
          return start.toDateString() === now.toDateString();
        }).length;
        const week = logs.filter((item) => {
          if (!item.startTime) return false;
          const start = new Date(item.startTime);
          const now = new Date();
          const diff = now.getTime() - start.getTime();
          return diff <= 7 * 24 * 60 * 60 * 1000;
        }).length;
        const success = logs.filter((item) => item.status === "completed").length;
        const running = logs.some((item) => item.status === "running");
        return {
          display: {
            "전체 완료": total,
            "오늘 완료": today,
            "이번 주 완료": week,
            "성공률": `${total === 0 ? 0 : Math.round((success / total) * 100)}%`
          },
          running
        };
      }

      function formatTimestamp(value) {
        if (!value) return "미정";
        const time = typeof value === "number" ? value : parseInt(value, 10);
        if (!time) return "미정";
        const dt = new Date(time);
        return `${dt.getFullYear()}-${twoDigits(dt.getMonth() + 1)}-${twoDigits(dt.getDate())} ${twoDigits(dt.getHours())}:${twoDigits(dt.getMinutes())}`;
      }

      function twoDigits(num) {
        return num.toString().padStart(2, "0");
      }

      render();
    </script>
  </body>
</html>
